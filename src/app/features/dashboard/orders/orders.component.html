<div class="orders-container">
  <!-- Cabeçalho -->
  <div class="flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="text-3xl font-bold text-900 m-0 mb-2">
        Meus Pedidos
        <span 
          *ngIf="getPedidosPendentesCount() > 0" 
          class="p-badge p-badge-danger ml-2"
          style="vertical-align: middle;"
        >
          {{ getPedidosPendentesCount() }}
        </span>
      </h1>
      <p class="text-600 m-0">Gerencie os pedidos em tempo real</p>
    </div>
    <div class="flex gap-2">
      <button 
        pButton 
        icon="pi pi-refresh" 
        label="Atualizar"
        class="p-button-outlined"
        (click)="loadOrders()"
        [loading]="loading"
      ></button>
      <button 
        pButton 
        icon="pi pi-plus" 
        label="Novo Pedido"
        class="p-button-success"
        (click)="abrirModalNovoPedido()"
      ></button>
    </div>
  </div>

  <!-- Grid de Colunas de Status -->
  <div class="grid">
    <div 
      *ngFor="let column of columns" 
      class="col-12 md:col-4"
    >
      <!-- Cabeçalho da Coluna -->
      <div class="column-header p-3 mb-3 border-round" [style.background-color]="column.color">
        <div class="flex align-items-center justify-content-between">
          <h3 class="text-white m-0 font-semibold">{{ column.title }}</h3>
          <span class="text-white bg-white-alpha-30 px-2 py-1 border-round font-semibold">
            {{ ordersByColumn[column.title].length || 0 }}
          </span>
        </div>
      </div>

      <!-- Cards de Pedidos -->
      <div class="orders-list">
        <div 
          *ngFor="let order of ordersByColumn[column.title]" 
          class="order-card surface-card p-3 mb-3 border-round shadow-2 cursor-pointer hover:shadow-4 transition-all transition-duration-300"
          (click)="abrirDetalhesPedido(order)"
        >
          <!-- Cabeçalho do Pedido -->
          <div class="flex align-items-center justify-content-between mb-3">
            <div class="flex align-items-center gap-2">
              <span class="font-bold text-xl text-primary">#{{ order.numero }}</span>
              <span 
                class="badge px-2 py-1 border-round text-xs font-semibold"
                [class.badge-delivery]="getOrderType(order) === 'delivery'"
                [class.badge-pickup]="getOrderType(order) === 'pickup'"
              >
                <i [class]="getOrderType(order) === 'delivery' ? 'pi pi-car' : 'pi pi-shopping-bag'" class="mr-1"></i>
                {{ getOrderType(order) === 'delivery' ? 'Entrega' : 'Retirada' }}
              </span>
            </div>
            <span class="text-500 text-sm">{{ getOrderTime(order) }}</span>
          </div>

          <!-- Informações do Cliente -->
          <div class="mb-3">
            <p class="font-semibold text-900 m-0 mb-1">{{ getCustomerName(order) }}</p>
            <p class="text-600 text-sm m-0 mb-1" *ngIf="getCustomerPhone(order)">
              <i class="pi pi-phone mr-1"></i>
              {{ getCustomerPhone(order) }}
            </p>
            <p class="text-600 text-sm m-0" *ngIf="getDeliveryAddress(order)">
              <i class="pi pi-map-marker mr-1"></i>
              {{ getDeliveryAddress(order) }}
            </p>
          </div>

          <!-- Itens do Pedido -->
          <div class="mb-3 p-2 surface-ground border-round">
            <div *ngIf="order.itens && order.itens.length > 0; else itemsCount">
              <div *ngFor="let item of order.itens" class="flex justify-content-between text-sm mb-1">
                <span class="text-700">{{ item.quantidade }}x {{ item.produto?.nome || 'Produto' }}</span>
                <span class="text-900 font-semibold">{{ orderService.formatCurrency(item.subtotal) }}</span>
              </div>
            </div>
            <ng-template #itemsCount>
              <div class="flex justify-content-between text-sm mb-1">
                <span class="text-700">{{ getTotalItems(order) }} itens no pedido</span>
              </div>
            </ng-template>
            <div *ngIf="order.observacoes" class="mt-2 pt-2 border-top-1 surface-border">
              <p class="text-600 text-sm m-0">
                <i class="pi pi-info-circle mr-1"></i>
                <strong>Obs:</strong> {{ order.observacoes }}
              </p>
            </div>
          </div>

          <!-- Rodapé do Card -->
          <div class="flex align-items-center justify-content-between pt-2 border-top-1 surface-border">
            <div>
              <p class="text-xs text-500 m-0 mb-1">Total</p>
              <p class="text-xl font-bold text-primary m-0">{{ orderService.formatCurrency(order.total) }}</p>
            </div>
            <div class="flex gap-2" *ngIf="column.title !== 'Pronto para Entrega'">
              <button 
                pButton 
                icon="pi pi-arrow-right"
                class="p-button-sm p-button-success"
                [pTooltip]="'Mover para ' + columns[columns.indexOf(column) + 1].title"
                tooltipPosition="top"
                (click)="moveToNextStatus(order, column); $event.stopPropagation()"
              ></button>
            </div>
          </div>

          <!-- Botão Finalizar Pedido (apenas na coluna Pronto para Entrega) -->
          <div *ngIf="column.title === 'Pronto para Entrega'" class="mt-3">
            <button 
              pButton 
              label="Finalizar Pedido"
              icon="pi pi-check"
              class="p-button-success w-full btn-finalizar-pedido"
              (click)="finalizarPedido(order); $event.stopPropagation()"
            ></button>
          </div>

          <!-- Tempo Estimado -->
          <div *ngIf="order.tempoEstimado" class="mt-2 p-2 bg-blue-50 border-round text-center">
            <span class="text-sm text-blue-700">
              <i class="pi pi-clock mr-1"></i>
              Tempo estimado: {{ order.tempoEstimado }} min
            </span>
          </div>
        </div>

        <!-- Mensagem quando não há pedidos -->
        <div 
          *ngIf="!ordersByColumn[column.title] || ordersByColumn[column.title].length === 0"
          class="surface-card p-4 border-round text-center"
        >
          <i class="pi pi-inbox text-4xl text-400 mb-2"></i>
          <p class="text-600 m-0">Nenhum pedido nesta etapa</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Novo Pedido -->
<app-modal-novo-pedido
  [(visible)]="modalNovoPedidoVisible"
  (pedidoCriado)="onPedidoCriado()">
</app-modal-novo-pedido>

<!-- Modal Detalhes do Pedido -->
<app-modal-detalhes-pedido
  [(visible)]="modalDetalhesPedidoVisible"
  [pedido]="pedidoSelecionado"
  (pedidoAtualizado)="onPedidoAtualizado()">
</app-modal-detalhes-pedido>
